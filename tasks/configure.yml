---
# The GPII framework tests on Fedora require that Orca has been set up.

- name: Check to see if the Orca user directory exists
  stat:
    path: "{{ gpii_framework_user_home_dir }}/.local/share/orca"
  register: gpii_framework_orca_dir_result

- name: Create Orca user directory if required
  file:
    path: "{{ gpii_framework_user_home_dir }}/.local/share/orca"
    state: directory
    mode: 0755
    owner: "{{ gpii_framework_username }}"
    group: "{{ gpii_framework_groupname }}"
  when: gpii_framework_orca_dir_result.stat.exists == false
    
- name: Create Orca configuration file
  copy:
    src: orca-user-settings.conf
    dest: "{{ gpii_framework_user_home_dir }}/.local/share/orca/user-settings.conf"
    owner: "{{ gpii_framework_username }}"
    group: "{{ gpii_framework_groupname }}"
  when: gpii_framework_orca_dir_result.stat.exists == false
  
# gpii/universal gets installed to the parent node_modules directory relative to gpii/linux
# https://github.com/GPII/grunt-gpii/blob/master/tasks/gpii.js#L25
#
# If a npm path workaround is being used then node_modules/universal in the temporary build
# directory needs to be copied back to where the application is located.
# https://github.com/idi-ops/ansible-nodejs/blob/1b849100e68de4d22ef627a709734f67a7314cef/tasks/configure.yml#L23-L29
- name: Copy universal from the temporary build location to the app installation directory if a Vagrant npm path workaround is being used
  command: rsync -a "{{ nodejs_app_tmp_build_dir }}/../node_modules" "{{ nodejs_app_install_dir }}/../"
  when: (is_vagrant) and (nodejs_app_commands)

